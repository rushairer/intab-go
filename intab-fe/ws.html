<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<title>Chat Example</title>
<script type="text/javascript">
window.onload = function () {
    var conn;
    var lockReconnect = false;//é¿å…é‡å¤è¿æ¥
    var msg = document.getElementById("msg");
    var log = document.getElementById("log");
    var host = "intab.api.cafegg.com";
    var uid = prompt("Please input your nickname");
    //var host = "127.0.0.1:8080";

    function appendLog(item) {
        var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
        log.appendChild(item);
        if (doScroll) {
            log.scrollTop = log.scrollHeight - log.clientHeight;
        }
    }

    function reconnect(url) {
        if(lockReconnect) {
            return;
        }
        lockReconnect = true;
        //æ²¡è¿æ¥ä¸Šä¼šä¸€ç›´é‡è¿ï¼Œè®¾ç½®å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¤š
        setTimeout(function () {
            createWebSocket(url);
            lockReconnect = false;
        }, 2000);
    }

    document.getElementById("form").onsubmit = function () {
        if (!conn) {
            return false;
        }
        if (!msg.value) {
            return false;
        }
        conn.send(JSON.stringify({ type: 'msg', uid: uid, data: msg.value}));
        msg.value = "";
        return false;
    };

    if (window["WebSocket"]) {
        var url = "wss://" + host + "/ws?tid=1&uid="+uid
        conn = new WebSocket(url);
        conn.onclose = function (evt) {
            reconnect(url);
        };
        conn.onerror = function (evt) {
            reconnect(url);
        };
        conn.onopen = function (evt) {
            heartCheck.reset().start();
            conn.send(JSON.stringify({ type: 'join', uid: uid}));
        };
        conn.onmessage = function (evt) {
            heartCheck.reset().start();

            var messages = evt.data.split('\n');

            if (messages[0] == "PING") {
                console.log("recv PONG from server");
            } else {
                for (var i = 0; i < messages.length; i++) {
                    var item = document.createElement("div");
                    json = JSON.parse(messages[i]);

                    if (json.type == "msg") {
                        item.innerText = "[" + json.uid + "]: " + json.data;
                    } else {
                        item.innerHTML = "<b>ğŸ‰  " + json.uid + " join us!</b>";
                    }
                    appendLog(item);
                }
            }
        };
    } else {
        var item = document.createElement("div");
        item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
        appendLog(item);
    }


    //å¿ƒè·³æ£€æµ‹
    var heartCheck = {
        timeout: 60000,//60ç§’
        timeoutObj: null,
        serverTimeoutObj: null,
        reset: function(){
            clearTimeout(this.timeoutObj);
            clearTimeout(this.serverTimeoutObj);
            return this;
        },
        start: function(){
            var self = this;
            this.timeoutObj = setTimeout(function(){
                //è¿™é‡Œå‘é€ä¸€ä¸ªå¿ƒè·³ï¼Œåç«¯æ”¶åˆ°åï¼Œè¿”å›ä¸€ä¸ªå¿ƒè·³æ¶ˆæ¯ï¼Œ
                //onmessageæ‹¿åˆ°è¿”å›çš„å¿ƒè·³å°±è¯´æ˜è¿æ¥æ­£å¸¸
                conn.send("PING");
                self.serverTimeoutObj = setTimeout(function(){//å¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´è¿˜æ²¡é‡ç½®ï¼Œè¯´æ˜åç«¯ä¸»åŠ¨æ–­å¼€äº†
                    conn.close();//å¦‚æœoncloseä¼šæ‰§è¡Œreconnectï¼Œæˆ‘ä»¬æ‰§è¡Œclose()å°±è¡Œäº†.å¦‚æœç›´æ¥æ‰§è¡Œreconnect ä¼šè§¦å‘oncloseå¯¼è‡´é‡è¿ä¸¤æ¬¡
                }, self.timeout)
            }, this.timeout)
        }
    }


};
</script>
<style type="text/css">
    html {
        overflow: hidden;
    }

    body {
        overflow: hidden;
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
        background: gray;
    }

    #log {
        background: white;
        margin: 0;
        padding: 0.5em 0.5em 0.5em 0.5em;
        position: absolute;
        top: 0.5em;
        left: 0.5em;
        right: 0.5em;
        bottom: 3em;
        overflow: auto;
    }

    #form {
        padding: 0 0.5em 0 0.5em;
        margin: 0;
        position: absolute;
        bottom: 1em;
        left: 0px;
        width: 100%;
        overflow: hidden;
    }

</style>
</head>
<body>
    <div id="log"></div>
    <form id="form">
        <input type="submit" value="Send" />
        <input type="text" id="msg" size="64"/>
    </form>
</body>
</html>
